oathkeeper:
  accessRules: |
    - id: "browser-auth"
      match:
        url: "<.*>"
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS"]
      authenticators:
        - handler: cookie_session
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-User: "{{ print .Subject }}"
      errors:
        - handler: redirect
          config:
            to: https://kratos.kieranajp.uk/self-service/login/browser?return_to={{ .RequestURL }}

  config:
    serve:
      proxy:
        port: 4455
      api:
        port: 4456

    authenticators:
      cookie_session:
        enabled: true
        config:
          check_session_url: http://kratos-public:4433/sessions/whoami
          preserve_path: true
          extra_from: "@this"
          subject_from: "identity.id"
          only:
            - ory_kratos_session
          forward_http_headers:
            - Cookie
            - Authorization
      jwt:
        enabled: true
        config:
          jwks_urls:
            - http://hydra-public:4444/.well-known/jwks.json
          scope_strategy: exact
      noop:
        enabled: true

    authorizers:
      allow:
        enabled: true

    mutators:
      noop:
        enabled: true
      header:
        enabled: true
        config:
          headers:
            X-User: "{{ print .Subject }}"

    errors:
      fallback:
        - redirect
      handlers:
        redirect:
          enabled: true
          config:
            to: https://kratos.kieranajp.uk/self-service/login/browser?return_to={{ .RequestURL }}
        json:
          enabled: true
          config:
            verbose: true

deployment:
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"


service:
  proxy:
    enabled: true
    type: ClusterIP
    port: 4455
  api:
    enabled: true
    type: ClusterIP
    port: 4456